# .github/workflows/deploy_dagster.yml

name: CI/CD - Deploy Dagster Pipeline

# DÃ©clencheur: se lance sur push vers 'main'
on:
  push:
    branches:
      - main

env:
  # Nom de l'image Docker sur le GitHub Container Registry
  IMAGE_NAME: ghcr.io/${{ github.repository }}:latest

# --- DÃ‰FINITION DES TÃ‚CHES (JOBS) ---
jobs:
  
  # --- TÃ‚CHE 1: CONSTRUIRE L'IMAGE ET LA POUSSER ---
  build-and-push-image:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write 
    steps:
      - name: 1. Cloner le dÃ©pÃ´t
        uses: actions/checkout@v3

      - name: 2. Se connecter au GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: 3. Construire et Pousser l'image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ env.IMAGE_NAME }}
          build-args: |
            DAGSTER_REQUIREMENTS_FILE=requirements_dagster.txt

  # --- TÃ‚CHE 2: DÃ‰PLOYER L'IMAGE SUR LE SERVEUR ---
  deploy-to-droplet:
    needs: build-and-push-image # DÃ©pend de la TÃ¢che 1
    runs-on: ubuntu-latest

    steps:
      - name: 1. DÃ©ployer sur le serveur DigitalOcean
        uses: appleboy/ssh-action@v1.0.3 # L'action de dÃ©ploiement SSH
        with:
          # 1. Infos de connexion (depuis les secrets GitHub)
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          
          # 2. Variables d'environnement Ã  passer au serveur
          env:
            ENV_FILE_PAYLOAD: ${{ secrets.ENV_FILE_CONTENT }}
            DEPLOY_IMAGE_NAME: ${{ env.IMAGE_NAME }}
          
          # 3. Le script Ã  exÃ©cuter sur le serveur
          script: |
            echo "âœ… 1/5 - Connexion SSH rÃ©ussie"
            
            # On dÃ©finit le chemin absolu et on s'y place
            export DEPLOY_DIR="/root/anime-data-platform"
            cd $DEPLOY_DIR
            
            echo "ğŸ”‘ 2/5 - CrÃ©ation du fichier .env..."
            # On Ã©crit la variable d'env (qui contient tous tes secrets)
            # dans le fichier .env sur le serveur.
            echo "$ENV_FILE_PAYLOAD" > $DEPLOY_DIR/.env
            echo "âœ… Fichier .env crÃ©Ã©."

            echo "ğŸ³ 3/5 - Pull de la nouvelle image: $DEPLOY_IMAGE_NAME"
            docker pull $DEPLOY_IMAGE_NAME
            
            echo "ğŸ›‘ 4/5 - ArrÃªt de l'ancien conteneur dagster_app"
            docker rm -f dagster_app || true
            
            echo "ğŸš€ 5/5 - DÃ©marrage du nouveau conteneur !"
            docker run -d -p 3000:3000 \
              --env-file $DEPLOY_DIR/.env \
              -v dagster_storage:/app/dagster_home \
              --name dagster_app \
              --restart always \
              $DEPLOY_IMAGE_NAME
            
            echo "ğŸ‰ DÃ©ploiement terminÃ© !"