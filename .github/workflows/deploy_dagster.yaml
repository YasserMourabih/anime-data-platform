# .github/workflows/deploy_dagster.yml

name: CI/CD - Deploy Dagster Pipeline

on:
  push:
    branches:
      - main

env:
  IMAGE_NAME: ghcr.io/yassermourabih/anime-data-platform:latest

jobs:
  
  # --- T√ÇCHE 1: CONSTRUIRE L'IMAGE ---
  build-and-push-image:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write 
    steps:
      - name: 1. Cloner le d√©p√¥t
        uses: actions/checkout@v3
      - name: 2. Se connecter au GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: 3. Construire et Pousser l'image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ env.IMAGE_NAME }}
          build-args: |
            DAGSTER_REQUIREMENTS_FILE=requirements_dagster.txt

  # --- T√ÇCHE 2: D√âPLOYER LE CONTENEUR ---
  deploy-to-droplet:
    needs: build-and-push-image
    runs-on: ubuntu-latest

    steps:
      - name: 1. D√©ployer sur le serveur DigitalOcean
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          script_stop: true
          
          # Le script √† ex√©cuter sur le serveur
          # On n'√©crit PLUS de fichier .env !
          script: |
            echo "‚úÖ 1/4 - Connexion SSH r√©ussie"
            
            echo "üê≥ 2/4 - Pull de la nouvelle image: ${{ env.IMAGE_NAME }}"
            docker pull ${{ env.IMAGE_NAME }}
            
            echo "üõë 3/4 - Arr√™t de l'ancien conteneur dagster_app"
            docker rm -f dagster_app || true
            
            echo "üöÄ 4/4 - D√©marrage du nouveau conteneur (avec variables inject√©es)"
            # On passe chaque variable d'env une par une.
            # C'est 1000x plus robuste.
            docker run -d -p 3000:3000 \
              -e DB_HOST="${{ secrets.DB_HOST }}" \
              -e DB_PORT="${{ secrets.DB_PORT }}" \
              -e DB_NAME="${{ secrets.DB_NAME }}" \
              -e DB_USER="${{ secrets.DB_USER }}" \
              -e DB_PASS="${{ secrets.DB_PASS }}" \
              -e SSL_MODE="${{ secrets.SSL_MODE }}" \
              -e ANILIST_API_URL="${{ secrets.ANILIST_API_URL }}" \
              -e GITHUB_TOKEN="${{ secrets.DEPLOY_GITHUB_TOKEN }}" \
              -e GITHUB_REPO="${{ secrets.PROJECT_REPO }}" \
              -e GITHUB_RELEASE_TAG="${{ secrets.PROJECT_RELEASE_TAG }}" \
              -v dagster_storage:/app/dagster_home \
              --name dagster_app \
              --restart always \
              ${{ env.IMAGE_NAME }}
            
            echo "üéâ D√©ploiement termin√© !"