name: CI/CD - Deploy Dagster Pipeline

on:
  push:
    branches:
      - main

env:
  IMAGE_NAME: ghcr.io/yassermourabih/anime-data-platform:latest

jobs:
  build-and-push-image:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: 1. Cloner le dÃ©pÃ´t
        uses: actions/checkout@v3

      - name: 2. Se connecter au Registre de Conteneurs GitHub (GHCR)
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: 3. Construire et Pousser l'image Docker
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ env.IMAGE_NAME }}
          build-args: |
            DAGSTER_REQUIREMENTS_FILE=requirements_dagster.txt

  deploy-to-droplet:
    needs: build-and-push-image
    runs-on: ubuntu-latest

    steps:
      - name: 1. Installation de la clÃ© SSH
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.DO_SSH_KEY }}

      - name: 2. Ajout du serveur aux hÃ´tes connus (sÃ©curitÃ©)
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "${{ secrets.DO_HOST }}" >> ~/.ssh/known_hosts

      - name: 3. Connexion SSH et DÃ©ploiement
        env:
          ENV_PAYLOAD: ${{ secrets.ENV_FILE_CONTENT }}
        run: |
          ssh ${{ secrets.DO_USER }}@${{ secrets.DO_HOST }} "bash -l" <<'ENDSSH'
            
            echo " 1/5 - Connexion SSH rÃ©ussie"

            # Utiliser un chemin absolu
            export DEPLOY_DIR="/root/anime-data-platform"

            cd $DEPLOY_DIR
                        
            echo " 2/5 - CrÃ©ation du fichier .env..."
            # On Ã©crit le contenu de la variable d'env dans le fichier .env
            # Les guillemets sont cruciaux pour prÃ©server les nouvelles lignes
            echo "$ENV_PAYLOAD" > $DEPLOY_DIR/.env
            echo " Fichier .env crÃ©Ã©."
            
            echo " 3/5 - Pull de la nouvelle image: ${{ env.IMAGE_NAME }}"
            docker pull ${{ env.IMAGE_NAME }}
            
            echo " 4/5 - ArrÃªt de l'ancien conteneur dagster_app"
            docker rm -f dagster_app || true
            
            echo " 5/5 - DÃ©marrage du nouveau conteneur !"
            # Utiliser le chemin absolu pour --env-file
            docker run -d -p 3000:3000 \
              --env-file $DEPLOY_DIR/.env \
              -v dagster_storage:/app/dagster_home \
              --name dagster_app \
              --restart always \
              ${{ env.IMAGE_NAME }}
            
            echo "ðŸŽ‰ DÃ©ploiement terminÃ© !"
          ENDSSH