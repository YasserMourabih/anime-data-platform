# --- T√ÇCHE 2: D√âPLOYER LE CONTENEUR ---
  deploy-to-droplet:
    needs: build-and-push-image
    runs-on: ubuntu-latest

    steps:
      - name: 1. D√©ployer sur le serveur DigitalOcean
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          script_stop: true
          
          # Le script √† ex√©cuter sur le serveur
          script: |
            echo "‚úÖ 1/5 - Connexion SSH r√©ussie"
            
            export DEPLOY_DIR="/root/anime-data-platform"
            cd $DEPLOY_DIR
            
            echo "üê≥ 2/5 - Pull de la nouvelle image: ${{ env.IMAGE_NAME }}"
            docker pull ${{ env.IMAGE_NAME }}
            
            echo "üõë 3/5 - Arr√™t de l'ancien conteneur dagster_app"
            docker rm -f dagster_app || true
            
            # --- CORRECTION FINALE : √âcrire le .env de mani√®re robuste ---
            echo "üîë 4/5 - Cr√©ation du fichier .env sur le serveur..."
            
            # On utilise "cat <<EOF" pour √©crire le fichier .env ligne par ligne
            # C'est la m√©thode la plus s√ªre pour les secrets
            cat <<EOF > $DEPLOY_DIR/.env
            DB_HOST=${{ secrets.DB_HOST }}
            DB_PORT=${{ secrets.DB_PORT }}
            DB_NAME=${{ secrets.DB_NAME }}
            DB_USER=${{ secrets.DB_USER }}
            DB_PASS=${{ secrets.DB_PASS }}
            SSL_MODE=${{ secrets.SSL_MODE }}
            ANILIST_API_URL=${{ secrets.ANILIST_API_URL }}
            GITHUB_TOKEN=${{ secrets.DEPLOY_GITHUB_TOKEN }}
            GITHUB_REPO=${{ secrets.PROJECT_REPO }}
            GITHUB_RELEASE_TAG=${{ secrets.PROJECT_RELEASE_TAG }}
            EOF
            echo "‚úÖ Fichier .env cr√©√©."

            echo "üöÄ 5/5 - D√©marrage du nouveau conteneur !"
            # On utilise --env-file qui pointe vers le fichier qu'on vient de cr√©er
            docker run -d -p 3000:3000 \
              --env-file $DEPLOY_DIR/.env \
              -v dagster_storage:/app/dagster_home \
              --name dagster_app \
              --restart always \
              ${{ env.IMAGE_NAME }}
            
            echo "üéâ D√©ploiement termin√© !"