name: CI/CD - Deploy Dagster Pipeline

on:
  push:
    branches:
      - main

env:
  IMAGE_NAME: ghcr.io/yassermourabih/anime-data-platform:latest

jobs:
  build-and-push-image:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: 1. Cloner le dépôt
        uses: actions/checkout@v3

      - name: 2. Se connecter au Registre de Conteneurs GitHub (GHCR)
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: 3. Construire et Pousser l'image Docker
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ env.IMAGE_NAME }}
          build-args: |
            DAGSTER_REQUIREMENTS_FILE=requirements_dagster.txt

  deploy-to-droplet:
    needs: build-and-push-image
    runs-on: ubuntu-latest

    steps:
      - name: 1. Installation de la clé SSH
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.DO_SSH_KEY }}

      - name: 2. Ajout du serveur aux hôtes connus (sécurité)
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "${{ secrets.DO_HOST }}" >> ~/.ssh/known_hosts

      - name: 3. Connexion SSH et Déploiement
        run: |
          ssh ${{ secrets.DO_USER }}@${{ secrets.DO_HOST }} '
            echo "1/5 - Connexion SSH réussie"

            echo "2/5 - Création du fichier .env..."
            echo '${{ secrets.ENV_FILE_CONTENT }}' > ~/anime-data-platform/.env

            echo "3/5 - Pull de la nouvelle image: ${{ env.IMAGE_NAME }}"
            docker pull ${{ env.IMAGE_NAME }}

            echo "4/5 - Arrêt de l'ancien conteneur dagster_app"
            docker rm -f dagster_app || true

            echo "5/5 - Démarrage du nouveau conteneur !"
            docker run -d -p 3000:3000 \
              --env-file ~/anime-data-platform/.env \
              -v dagster_storage:/app/dagster_home \
              --name dagster_app \
              --restart always \
              ${{ env.IMAGE_NAME }}

            echo "Déploiement terminé !"
          '